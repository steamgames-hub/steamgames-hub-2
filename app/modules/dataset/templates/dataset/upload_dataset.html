{% extends "base_template.html" %}

{% block title %}Upload dataset{% endblock %}

{% block content %}

    <div id="myModal" class="modal">
        
        <div class="modal-content">
            <h2>Do you really want to <strong>exit</strong>?</h2>
            <p class="p-0 m-0">
                You can now decide whether your dataset will be saved as a draft or not. If you check the box, every dataset you leave without uploading will be saved as draft.
            </p>
            <div class="modal-buttons-container">
                <button class="btn btn-primary mt-2" onclick="saveDraft(true)">Save as draft</button>
                <div class="checkbox-container">
                    <input type="checkbox" id="save_drafts_preference">
                    <label for="save_drafts_preference" class="checkbox-label">Always save next drafts</label>
                </div>
                <button class="btn btn-secondary mt-2" onclick="discardDraft()">Discard draft</button>
            </div>
        </div>
    </div>
    {% if not save_drafts or editing_dataset %}
    <script>
        document.querySelectorAll('a').forEach(link => {
            if(link.getAttribute("class") === 'sidebar-link' || link.getAttribute("class") === 'sidebar-brand'){
                link.addEventListener('click', function(event) {
                    if (!hasAnswered) {
                        hasAnswered = true;
                        urlToLeave = link.getAttribute("href");
                        showModal(event);
                    }
                });
            }
        });
    </script>
    {% else %}
    <script>document.querySelectorAll('a').forEach(link => {
            if(link.getAttribute("class") === 'sidebar-link' || link.getAttribute("class") === 'sidebar-brand'){
                link.addEventListener('click', function(event) {
                    saveDraft(false)
                });
            }
        });
    </script>
    {% endif %}
    <h1 class="h2 mb-3"><b>{% if editing_dataset %}Edit{% else %}Upload{% endif %}</b> dataset</h1>

    <div class="row">
        <div class="col-12 mb-3">
            <div class="alert alert-warning" role="alert" id="test_zenodo_connection_error" style="display: none">
                <div class="alert-message">

                    <h4 class="alert-heading"><i class="align-middle" data-feather="alert-triangle"></i> Limited
                        connection to the Zenodo API</h4>
                    <p class="p-0 m-0">
                        There seems to be some kind of problem with the Zenodo API and synchronization of your dataset
                        files may not be possible. We will save your files locally to eventually synchronize them with
                        Zenodo. Sorry for the inconvenience, Zenodo is an external service and we can't do
                        anything about it.
                    </p>
                </div>
            </div>
        </div>

    </div>

    {% if messages %}
        <ul>
            {% for message in messages %}
                <li>{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}

    <div class="row">

        <div class="col-xl-6 col-lg-12 col-md-12 col-sm-12">
            <div id="basic_info_form">

                {{ form.hidden_tag() }}

                <div class="row">

                    <div class="col-12">

                        <h1 class="h3 mb-3">Basic info</h1>

                        <div class="row" style="padding-left: 2rem">

                            

                            <div class="col-lg-6 col-xs-12 col-md-12">
                                <div class="mb-3">
                                    {{ form.title.label(class="form-label") }} *
                                    {{ form.title(class="form-control") }}
                                    {% for error in form.title.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="col-12">
                                <div class="mb-3">
                                    {{ form.desc.label(class="form-label") }} *
                                    {{ form.desc(rows=4, class="form-control") }}
                                    {% for error in form.desc.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="col-lg-6 col-6">
                                <div class="mb-3">
                                    {{ form.data_category.label(class="form-label") }}
                                    {{ form.data_category(class="form-control") }}
                                </div>

                            </div>

                            <div class="col-lg-6 col-6">
                                <div class="mb-3">
                                    {{ form.publication_doi.label(class="form-label") }}
                                    {{ form.publication_doi(class="form-control") }}
                                    {% for error in form.publication_doi.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="col-6">
                                <div class="mb-3">
                                    {{ form.tags.label(class="form-label") }}
                                    {{ form.tags(class="form-control") }}
                                    {% for error in form.tags.errors %}
                                        <span style="color: red;">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                        </div>

                        <h1 class="h3 mb-3 mt-4">
                          Authors
                          <a href="#" data-toggle="modal" data-target="#infoModal">
                            <i data-feather="info"></i> <!-- Usamos "info" porque Feather no tiene un ícono específico llamado "feather" para más info -->
                          </a>
                        </h1>

                        <!-- Modal -->
                        <div class="modal fade" id="infoModal" tabindex="-1" role="dialog" aria-labelledby="infoModalLabel" aria-hidden="true" style="display: none">
                          <div class="modal-dialog" role="document">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h5 class="modal-title" id="infoModalLabel">Información Importante</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                  <span aria-hidden="true">&times;</span>
                                </button>
                              </div>
                              <div class="modal-body">
                                ¡Cuidado! Los autores no se pueden editar una vez que el dataset se haya subido a UVLHub. Esta funcionalidad estará disponible para futuras versiones.
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                              </div>
                            </div>
                          </div>
                        </div>

                        <div class="row" style="padding-left: 2rem">

                            <div class="col-lg-6 col-12 mb-3">
                                <label class="form-label">Author name</label>
                                <input class="form-control"
                                       disabled
                                       value="{{ current_user.profile.surname }}, {{ current_user.profile.name }}">
                            </div>

                            <div class="col-lg-6 col-12 mb-3">
                                <label class="form-label">Author affiliation</label>
                                <input class="form-control"
                                       disabled value="{{ current_user.profile.affiliation }}">
                            </div>

                            <div class="col-lg-6 col-12 mb-3">
                                <label class="form-label">Author ORCID</label>
                                <input class="form-control"
                                       disabled value="{{ current_user.profile.orcid }}">
                            </div>

                            <div class="col-12">

                                <div class="mb-3">

                                    <div id="authors">
                                        {% for subform in form.authors %}
                                        <div class="row author" {% if not loop.first %}
                                            style="border:2px dotted #ccc;border-radius:10px;padding:10px;margin:10px 0; background-color: white"
                                            {% endif %}
                                        >
                                            <div class="col-lg-6 col-12 mb-3">
                                                {{ subform.form.name.label(class="form-label") }}
                                                {{ subform.form.name(class="form-control", disabled=loop.first) }}
                                                {% for error in subform.name.errors %}
                                                    <span style="color: red;">{{ error }}</span>
                                                {% endfor %}
                                            </div>

                                            <div class="col-lg-6 col-12 mb-3">
                                                {{ subform.form.affiliation.label(class="form-label") }}
                                                {{ subform.form.affiliation(class="form-control", disabled=loop.first) }}
                                                {% for error in subform.name.errors %}
                                                    <span style="color: red;">{{ error }}</span>
                                                {% endfor %}
                                            </div>

                                            <div class="col-lg-6 col-12 mb-3">
                                                {{ subform.orcid.label(class="form-label") }}
                                                {{ subform.orcid(class="form-control", disabled=loop.first) }}
                                                {% for error in subform.orcid.errors %}
                                                    <span style="color: red;">{{ error }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <button type="button" class="btn btn-secondary" id="add_author">Add author
                                    </button>

                                </div>

                            </div>


                        </div>

                    </div>

                </div>

                <div class="row">

                    {% if error %}

                        <div class="mt-3 col-lg-6 col-12">
                            <span style="color: red;">{{ error }}</span>
                        </div>

                    {% endif %}

                </div>


            </div>
        </div>

        <div class="col-xl-6 col-lg-12 col-md-12 col-sm-12">

            <h1 class="h3 mb-3 mt-2"><span id="files_title_heading">CSV files</span></h1>

            <div id="uploaded_models_form" style="padding-left: 2rem">

                <form action="{{ url_for('dataset.upload') }}" class="dropzone" id="myDropzone">
                    {% if editing_dataset is defined %}
                        <input type="hidden" name="editing_dataset_id" value="{{ editing_dataset.id }}">
                    {% endif %}
                    <div id="dropzone-text" class="text-muted" style="font-size: 0.9rem;"></div>
                </form>

                <div class="mt-2">
                    <thead class="text-muted">Required headers: <code>appid, name, release_date, is_free, developers, publishers, platforms, genres, tags</code></thead>
                </div>

                <span class="text-danger" id="alerts" style="display: none">
                    </span>

                <ul class="mt-2" id="file-list"></ul>

                {% if editing_dataset is defined %}
                    {# Render a simplified files block for editing: only filename + delete button #}
                    <div class="list-group" id="editing-files-list">
                        <div class="list-group-item">
                            <div class="row">
                                <div class="col-12 d-flex justify-content-between align-items-center">
                                    <h4 style="margin-bottom: 0px">CSV files (draft)</h4>
                                    <h4 style="margin-bottom: 0px;"><span class="badge bg-dark">{{ editing_dataset.get_files_count() }}</span></h4>
                                </div>
                            </div>
                        </div>

                        {% for fm in editing_dataset.feature_models %}
                            {% set i = loop.index0 %}
                            {% set fm_md = fm.fm_meta_data %}
                            <div class="list-group-item" data-fm-index="{{ i }}" id="editing-file-{{ i }}">
                                <div class="row align-items-center">
                                    <div class="col-9">
                                        <i data-feather="file"></i> {{ fm_md.csv_filename }}
                                    </div>
                                    <div class="col-3 text-end">
                                        <button type="button" class="btn btn-outline-danger btn-sm edit-file-delete" data-filename="{{ fm_md.csv_filename }}" data-fm-index="{{ i }}">Delete</button>
                                    </div>
                                </div>
                                {# Hidden inputs so server receives the same payload as when files are uploaded via Dropzone #}
                                <input type="hidden" name="feature_models-{{ i }}-csv_filename" value="{{ fm_md.csv_filename }}">
                                <input type="hidden" name="feature_models-{{ i }}-title" value="{{ fm_md.title }}">
                                <input type="hidden" name="feature_models-{{ i }}-desc" value="{{ fm_md.description }}">
                                <input type="hidden" name="feature_models-{{ i }}-data_category" value="{{ fm_md.data_category.value if fm_md.data_category else '' }}">
                                <input type="hidden" name="feature_models-{{ i }}-publication_doi" value="{{ fm_md.publication_doi }}">
                                <input type="hidden" name="feature_models-{{ i }}-tags" value="{{ fm_md.tags }}">
                                <input type="hidden" name="feature_models-{{ i }}-version" value="{{ fm_md.csv_version }}">

                                {% for author in fm_md.authors %}
                                    {% set j = loop.index0 %}
                                    <input type="hidden" name="feature_models-{{ i }}-authors-{{ j }}-name" value="{{ author.name }}">
                                    <input type="hidden" name="feature_models-{{ i }}-authors-{{ j }}-affiliation" value="{{ author.affiliation }}">
                                    <input type="hidden" name="feature_models-{{ i }}-authors-{{ j }}-orcid" value="{{ author.orcid }}">
                                {% endfor %}
                            </div>
                        {% endfor %}

                    </div>
                {% endif %}

                <script>
                    let dropzone = Dropzone.options.myDropzone = {
                        url: "/dataset/file/upload",
                        paramName: 'file',
                        maxFilesize: 10,
                        acceptedFiles: '.csv',
                        init: function () {

                            let fileList = document.getElementById('file-list');
                            let dropzoneText = document.getElementById('dropzone-text');
                            let alerts = document.getElementById('alerts');
                            let filesTitleHeading = document.getElementById('files_title_heading');
                            dropzoneText.textContent = 'Accepted: .csv';

                            // Keep a reference to the Dropzone instance
                            window.myDropzoneInstance = this;

                            this.on('sending', function (file, xhr, formData) {
                                try {

                                    if (fileList.children.length === 0) {
                                        var req = new XMLHttpRequest();
                                        req.open('POST', '/dataset/file/clean_temp', false); 
                                        req.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
                                        try {
                                            req.send(JSON.stringify({}));
                                            console.log('Clean temp response', req.status, req.responseText);
                                        } catch (e) {
                                            console.warn('Could not clean temp folder before upload', e);
                                        }
                                    }
                                } catch (e) {
                                    console.warn('Error in sending handler for cleaning temp folder', e);
                                }
                            });

                            this.on('addedfile', function (file) {

                                let ext = file.name.split('.').pop().toLowerCase();
                                const validExt = 'csv';
                                if (ext !== validExt) {
                                    this.removeFile(file);

                                    let alert = document.createElement('p');
                                    alert.textContent = 'Invalid file extension for ' + selectedType + ': ' + file.name;
                                    alerts.appendChild(alert);
                                    alerts.style.display = 'block';
                                }

                            });

                            this.on('success', function (file, response) {

                                let dropzone = this;

                                show_upload_dataset();

                                console.log("File uploaded: ", response);
                                // actions when file is uploaded (CSV only)
                                let listItem = document.createElement('li');
                                let h4Element = document.createElement('h4');
                                h4Element.textContent = response.filename;
                                listItem.appendChild(h4Element);
                                // store filename for later server-side deletion on type switch
                                listItem.dataset.filename = response.filename;
                                // track server filename on the Dropzone file object to match later
                                try { file._serverFilename = response.filename; } catch (e) {}

                                // generate incremental id for form
                                let formUniqueId = generateIncrementalId();

                                /*
                                    ##########################################
                                    FORM BUTTON
                                    ##########################################
                                */
                                let formButton = document.createElement('button');
                                formButton.innerHTML = 'Show info';
                                formButton.classList.add('info-button', 'btn', 'btn-outline-secondary', "btn-sm");
                                formButton.style.borderRadius = '5px';
                                formButton.id = formUniqueId + "_button";

                                formButton.addEventListener('click', function () {
                                    if (formContainer.style.display === "none") {
                                        formContainer.style.display = "block";
                                        formButton.innerHTML = 'Hide info';
                                    } else {
                                        formContainer.style.display = "none";
                                        formButton.innerHTML = 'Add info';
                                    }
                                });

                                // append space
                                let space = document.createTextNode(" ");
                                listItem.appendChild(space);

                                /*
                                    ##########################################
                                    REMOVE BUTTON
                                    ##########################################
                                */

                                // remove button
                                let removeButton = document.createElement('button');
                                removeButton.innerHTML = 'Delete model';
                                removeButton.classList.add("remove-button", "btn", "btn-outline-danger", "btn-sm", "remove-button");
                                removeButton.style.borderRadius = '5px';

                                // append space
                                space = document.createTextNode(" ");
                                listItem.appendChild(space);

                                removeButton.addEventListener('click', function () {
                                    fileList.removeChild(listItem);
                                    this.removeFile(file);

                                    // Ajax request
                                    let xhr = new XMLHttpRequest();
                                    xhr.open('POST', '/dataset/file/delete', true);
                                    xhr.setRequestHeader('Content-Type', 'application/json');
                                    xhr.onload = function () {
                                        if (xhr.status === 200) {
                                            console.log('Deleted file from server');

                                            if (dropzone.files.length === 0) {
                                                document.getElementById("upload_dataset").style.display = "none";
                                                clean_upload_errors();
                                            }

                                        }
                                    };
                                    const filenameToDelete = listItem.dataset.filename || file._serverFilename || file.name;
                                    xhr.send(JSON.stringify({file: filenameToDelete}));
                                }.bind(this));

                                /*
                                    ##########################################
                                    APPEND BUTTONS
                                    ##########################################
                                */
                                listItem.appendChild(formButton);
                                listItem.appendChild(removeButton);

                                /*
                                    ##########################################
                                    FILE INFO FORM (CSV)
                                    ##########################################
                                */

                                // create specific form for file metadata
                                let formContainer = document.createElement('div');
                                formContainer.id = formUniqueId + "_form";
                                formContainer.classList.add('file_form', "mt-3");
                                formContainer.style.display = "none";

                                formContainer.innerHTML = `
                                    <div class="row">
                                        <input type="hidden" value="${response.filename}" name="feature_models-${formUniqueId}-csv_filename">
                                        <div class="col-12">
                                            <div class="row">
                                                <div class="col-12">
                                                    <div class="mb-3">
                                                        <label class="form-label">Title</label>
                                                        <input type="text" class="form-control" name="feature_models-${formUniqueId}-title">
                                                    </div>
                                                </div>
                                                <div class="col-12">
                                                    <div class="mb-3">
                                                        <label class="form-label">Description</label>
                                                        <textarea rows="4" class="form-control" name="feature_models-${formUniqueId}-desc"></textarea>
                                                    </div>
                                                </div>
                                                <div class="col-lg-6 col-12">
                                                    <div class="mb-3">
                                                        <label class="form-label" for="data_category">Publication type</label>
                                                        <select class="form-control" name="feature_models-${formUniqueId}-data_category">
                                                            <option value="none">None</option>
                                                            <option value="annotationcollection">Annotation Collection</option>
                                                            <option value="book">Book</option>
                                                            <option value="section">Book Section</option>
                                                            <option value="conferencepaper">Conference Paper</option>
                                                            <option value="datamanagementplan">Data Management Plan</option>
                                                            <option value="article">Journal Article</option>
                                                            <option value="patent">Patent</option>
                                                            <option value="preprint">Preprint</option>
                                                            <option value="deliverable">Project Deliverable</option>
                                                            <option value="milestone">Project Milestone</option>
                                                            <option value="proposal">Proposal</option>
                                                            <option value="report">Report</option>
                                                            <option value="softwaredocumentation">Software Documentation</option>
                                                            <option value="taxonomictreatment">Taxonomic Treatment</option>
                                                            <option value="technicalnote">Technical Note</option>
                                                            <option value="thesis">Thesis</option>
                                                            <option value="workingpaper">Working Paper</option>
                                                            <option value="other">Other</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-lg-6 col-6">
                                                    <div class="mb-3">
                                                        <label class="form-label" for="publication_doi">Publication DOI</label>
                                                        <input class="form-control" name="feature_models-${formUniqueId}-publication_doi" type="text" value="">
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="mb-3">
                                                        <label class="form-label">Tags (separated by commas)</label>
                                                        <input type="text" class="form-control" name="feature_models-${formUniqueId}-tags">
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="mb-3">
                                <label class="form-label">File version</label>
                                <input type="text"
                                    class="form-control"
                                    name="feature_models-${formUniqueId}-version"
                                    placeholder="e.g., 1.2.3"
                                    pattern="^\\d+\\.\\d+\\.\\d+$"
                                    title="Version must follow x.y.z format (e.g., 1.2.3)">
                                                    </div>
                                                </div>
                                                <div class="col-12">
                                                    <div class="mb-3">
                                                        <label class="form-label">Authors</label>
                                                        <div id="` + formContainer.id + `_authors">
                                                        </div>
                                                        <button type="button" class="add_author_to_file btn btn-secondary" id="` + formContainer.id + `_authors_button">Add author</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    `;

                                listItem.appendChild(formContainer);
                                fileList.appendChild(listItem);

                            });

                            this.on('error', function (file, response) {
                                console.error("Error uploading file: ", response);
                                let alert = document.createElement('p');
                                alert.textContent = 'File not valid: ' + file.name;
                                alerts.appendChild(alert);
                                alerts.style.display = 'block';
                            });

                        }
                    };


                </script>

            </div>
        </div>

    </div>

    <div class="row" id="upload_dataset" style="display: none">

        <div class="col-12">

            <hr>

            <h1 class="h3 mb-3 mt-2">Upload dataset</h1>

            <div style="padding-left: 2rem">

                <label class="form-check">
                    <input id="agreeCheckbox" class="form-check-input" type="checkbox" value="">
                    <span class="form-check-label" style="font-size: 15px">
                                I agree to have my feature models automatically uploaded to Zenodo and made available to the public according to the <a
                            href="https://en.wikipedia.org/wiki/Open_science" target="_blank">Open Science</a> manifesto
                            </span>
                </label>

                {% if not editing_dataset or (editing_dataset and editing_dataset.draft_mode) %}
                <button id="upload_button" class="btn btn-primary mt-2" disabled>
                    <i data-feather="upload" class="center-button-icon"></i>
                    Upload dataset</button>
                {% else %}
                <button id="upload_minor_button" class="btn btn-primary mt-2" disabled>
                    <i data-feather="upload" class="center-button-icon"></i>
                    Update minor version (e.g., 1.0 → 1.1)</button>
                <button id="upload_major_button" class="btn btn-secondary mt-2 ms-2" disabled>
                    <i data-feather="upload" class="center-button-icon"></i>
                    Update major version (e.g., 1.2 → 2.0)</button>
                {% endif %}

                <div id="loading" style="display: none">
                    <img width="40px" src="{{ url_for("static", filename="gifs/loading.svg") }}"/>
                    {% if editing_dataset %}Updating{% else %}Uploading{% endif %} dataset, please wait...
                </div>

                <div class="row">
                    <div class="col-12 mb-3">

                    </div>
                </div>

                <div class="alert alert-error" role="alert" id="upload_error"
                     style="display: none">
                    <div class="alert-message">

                        <h4 class="alert-heading"><i class="align-middle" data-feather="alert-triangle"></i> Limited
                            connection to the Zenodo API</h4>
                        <p class="p-0 m-0">
                            There seems to be some kind of problem with the Zenodo API and synchronization of your
                            dataset
                            files may not be possible. We will save your files locally to eventually synchronize
                            them with
                            Zenodo. Sorry for the inconvenience, Zenodo is an external service and we can't do
                            anything about it.
                        </p>
                    </div>
                </div>


                <span class="text-danger mt-2" id="upload_error" style="display: none">

                    </span>

                {% if not editing_dataset or (editing_dataset and editing_dataset.draft_mode) %}
                <script>

                    const checkbox = document.getElementById('agreeCheckbox');
                    const upload_button = document.getElementById('upload_button');

                    checkbox.addEventListener('change', function () {
                        upload_button.disabled = !checkbox.checked;
                    });
                </script>
                {% else %}
                <script>
                    checkbox = document.getElementById('agreeCheckbox');
                    
                    const upload_minor_button = document.getElementById('upload_minor_button');
                    const upload_major_button = document.getElementById('upload_major_button');
                    
                    checkbox.addEventListener('change', function () {
                        upload_minor_button.disabled = !checkbox.checked;
                        upload_major_button.disabled = !checkbox.checked;
                    });
                </script>
                {% endif %}
                <script>
                    // Delete handler for files shown when editing a draft
                    document.querySelectorAll('.edit-file-delete').forEach(btn => {
                        btn.addEventListener('click', async function (ev) {
                            ev.preventDefault();
                            if (!confirm('Are you sure you want to delete this file?')) return;
                            const filename = btn.dataset.filename;
                            const fmIndex = btn.dataset.fmIndex;
                            try {
                                const res = await fetch('/dataset/file/delete', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                                    body: JSON.stringify({ file: filename })
                                });
                                const data = await res.json().catch(() => ({}));
                                if (res.ok) {
                                    // remove list item and related hidden inputs
                                    const el = document.getElementById('editing-file-' + fmIndex);
                                    if (el) el.remove();
                                    document.querySelectorAll(`input[name^="feature_models-${fmIndex}-"]`).forEach(i => i.remove());

                                    // Reindex remaining feature_models to keep sequential indices
                                    const remaining = Array.from(document.querySelectorAll('#editing-files-list [id^="editing-file-"]'));
                                    remaining.forEach((node, newIndex) => {
                                        const oldIndex = node.dataset.fmIndex;
                                        node.dataset.fmIndex = newIndex;
                                        node.id = 'editing-file-' + newIndex;
                                        // update delete button dataset and id
                                        const delBtn = node.querySelector('.edit-file-delete');
                                        if (delBtn) {
                                            delBtn.dataset.fmIndex = newIndex;
                                        }
                                        // rename hidden inputs
                                        const inputs = node.querySelectorAll('input[type="hidden"]');
                                        inputs.forEach(inp => {
                                            const oldName = inp.name || inp.getAttribute('name') || '';
                                            const newName = oldName.replace(/feature_models-\d+-/, `feature_models-${newIndex}-`);
                                            inp.name = newName;
                                        });
                                    });
                                    // update badges/count if present
                                    try {
                                        const badge = document.querySelector('#editing-files-list .badge');
                                        if (badge) badge.textContent = remaining.length;
                                    } catch (e) {}
                                } else {
                                    alert(data.message || 'Error deleting file');
                                }
                            } catch (e) {
                                console.error('Error deleting file', e);
                                alert('Error deleting file');
                            }
                        });
                    });

                    // Submit full dataset (metadata + references to uploaded files)
                    const loading = document.getElementById('loading');
                </script>

                {% if not editing_dataset or (editing_dataset and editing_dataset.draft_mode) %}
                <script>
                    async function submitUpload(versionType) {
                        if (upload_button.disabled) return;
                        upload_button.disabled = true;
                        if (loading) loading.style.display = 'block';

                        try {
                            const fd = new FormData();

                            // Collect all named form controls (inputs, selects, textareas)
                            document.querySelectorAll('input[name], select[name], textarea[name]').forEach(el => {
                                // Skip file inputs (Dropzone handles files)
                                if (el.type === 'file') return;
                                if (el.type === 'checkbox') {
                                    if (el.checked) {
                                        fd.append(el.name, el.value || 'on');
                                    }
                                } else {
                                    fd.append(el.name, el.value === undefined ? '' : el.value);
                                }
                            });

                            // Determine URL: if editing, use edit endpoint
                            const editingId = document.querySelector('input[name="editing_dataset_id"]')?.value;
                            const url = editingId ? `/dataset/${editingId}/edit` : '/dataset/upload';

                            const resp = await fetch(url, {
                                method: 'POST',
                                body: fd,
                                headers: { 'X-Requested-With': 'XMLHttpRequest' }
                            });
                            const json = await resp.json().catch(() => ({}));
                            if (resp.ok) {
                                // on success redirect to list page or reload
                                window.location.href = '/dataset/list';
                            } else {
                                alert(json.message || 'Error uploading dataset');
                            }

                        } catch (e) {
                            console.error('Upload error', e);
                            alert('Error uploading dataset');
                        } finally {
                            if (loading) loading.style.display = 'none';
                            upload_button.disabled = false;
                        }
                    }

                    upload_button.addEventListener('click', async function (ev) {
                        ev.preventDefault();
                        await submitUpload('major');  // default for new uploads
                    });

                </script>

                {% else %}
                <script>
                    async function submitUpload(versionType) {
                        if ((versionType === 'minor' && upload_minor_button.disabled) || (versionType === 'major' && upload_major_button.disabled)) return;
                        upload_minor_button.disabled = true;
                        upload_major_button.disabled = true;

                        if (loading) loading.style.display = 'block';

                        try {
                            const fd = new FormData();

                            // Collect all named form controls (inputs, selects, textareas)
                            document.querySelectorAll('input[name], select[name], textarea[name]').forEach(el => {
                                // Skip file inputs (Dropzone handles files)
                                if (el.type === 'file') return;
                                if (el.type === 'checkbox') {
                                    if (el.checked) {
                                        fd.append(el.name, el.value || 'on');
                                    }
                                } else {
                                    fd.append(el.name, el.value === undefined ? '' : el.value);
                                }
                            });

                            // Add version increment type
                            fd.append('version_increment_type', versionType);

                            // Determine URL: if editing, use edit endpoint
                            const editingId = document.querySelector('input[name="editing_dataset_id"]')?.value;
                            console.log('Editing ID:', editingId);
                            const url = editingId ? `/dataset/${editingId}/edit` : '/dataset/upload';

                            const resp = await fetch(url, {
                                method: 'POST',
                                body: fd,
                                headers: { 'X-Requested-With': 'XMLHttpRequest' }
                            });
                            const json = await resp.json().catch(() => ({}));
                            if (resp.ok) {
                                // on success redirect to list page or reload
                                window.location.href = '/dataset/list';
                            } else {
                                alert(json.message || 'Error uploading dataset');
                            }

                        } catch (e) {
                            console.error('Upload error', e);
                            alert('Error uploading dataset');
                        } finally {
                            if (loading) loading.style.display = 'none';
                            upload_minor_button.disabled = false;
                            upload_major_button.disabled = false;
                        }
                    }
                    
                    upload_minor_button.addEventListener('click', async function (ev) {
                        ev.preventDefault();
                        await submitUpload('minor');
                    });

                    upload_major_button.addEventListener('click', async function (ev) {
                        ev.preventDefault();
                        await submitUpload('major');
                    });
                </script>

                {% endif %}

            </div>

        </div>

    </div>


{% endblock %}

{% block scripts %}
    <script src="{{ url_for('dataset.scripts') }}"></script>
{% endblock %}