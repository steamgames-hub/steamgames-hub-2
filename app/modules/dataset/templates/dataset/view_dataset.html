{% extends "base_template.html" %}

{% block title %}View dataset{% endblock %}

{% block head_extra %}
<style>
.related-section-container,
.related-section-body {
  background: #fbfdff !important;                /* blanco suave (no choque con fondo) */
    border: 1px solid rgba(15,23,42,0.06) !important;
    border-radius: 14px !important;
    box-shadow: 0 10px 25px rgba(2,6,23,0.04) !important;
    padding: 18px !important;
}

/* Header: quitar bordes fuertes si existieran */
.related-section-header {
  border-bottom: 1px solid rgba(15,23,42,0.03) !important;
  padding-bottom: 0.5rem !important;
  margin-bottom: 0.75rem !important;
}

/* Grid: forzarlo si bootstrap lo cambia */
.related-section-grid {
  display: grid !important;
  grid-template-columns: repeat(3, minmax(0,1fr)) !important;
  gap: 1rem !important;
}

/* Tarjeta: fondo y sombra suaves, borde fino */
.related-dataset-card {
  background: linear-gradient(180deg,#ffffff 0%,#fbfdff 100%) !important;
  border: 1px solid rgba(15,23,42,0.04) !important;
  border-radius: 12px !important;
  padding: 12px !important;
  box-shadow: 0 10px 22px rgba(2,6,23,0.03) !important;
  transition: transform .12s ease, box-shadow .16s ease !important;
}

/* Hover discreto */
.related-dataset-card:hover {
  transform: translateY(-2px) !important;
  box-shadow: 0 16px 36px rgba(2,6,23,0.05) !important;
}

/* Flex interno: forzamos alineación como en tu HTML */
.related-card-content {
  display: flex !important;
  gap: 0.9rem !important;
  align-items: center !important;
  flex-wrap: wrap !important;
}

/* Thumb — tamaño fijo y fondo neutro */
.related-thumb {
  width: 52px !important;
  height: 52px !important;
  border-radius: 10px !important;
  background: #eef2f6 !important;
  color: #1f2937 !important;
  font-weight: 700 !important;
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  flex-shrink: 0 !important;
  overflow: hidden !important;
}

/* Si la imagen dentro tiene estilos propios, aseguramos el cover */
.related-thumb img {
  width: 100% !important;
  height: 100% !important;
  object-fit: cover !important;
  display: block !important;
}

/* Título: color y comportamiento */
.related-card-main .related-title {
  color: #0f172a !important;
  font-weight: 700 !important;
  text-decoration: none !important;
  display: block !important;
  margin-bottom: 0.25rem !important;
}
.related-card-main .related-title:hover {
  color: #1d4ed8 !important;
  text-decoration: underline !important;
}

/* Meta (autor + categoría) más discreto */
.related-meta {
  color: #6b7280 !important;
  font-size: 0.9rem !important;
  margin-bottom: 0.35rem !important;
}

/* Badges: evitar bg-primary o bg-light intensos de bootstrap */
.related-badges .related-badge {
  background: #f1f5f9 !important;
  color: #0f172a !important;
  border: 1px solid rgba(15,23,42,0.03) !important;
  font-size: 0.72rem !important;
  padding: 0.18rem 0.5rem !important;
  border-radius: 999px !important;
  text-transform: none !important;
}

/* Estadísticas (descargas/fecha) alineadas a la derecha en desktop,
   en mobile pasan abajo (por media query) */
.related-stats {
  min-width: 120px !important;
  color: #475569 !important;
  font-size: 0.92rem !important;
  text-align: right !important;
}
@media (max-width: 768px) {
  .related-stats { text-align: left !important; width: 100% !important; margin-top: .6rem !important; }
}

/* Iconos feather: color neutro y tamaño contenido */
.related-stats svg.feather { width: 18px !important; height: 18px !important; vertical-align: -3px !important; color: #94a3b8 !important; }

/* En caso de que Bootstrap añada .card o .shadow-sm, nulificamos comportamientos no deseados */
.related-dataset-card.card, .related-dataset-card.shadow-sm {
  box-shadow: 0 10px 22px rgba(2,6,23,0.03) !important;
  background: linear-gradient(180deg,#ffffff 0%,#fbfdff 100%) !important;
}
</style>
{% endblock %}

{% block content %}

<div class="row mb-3">

    <div class="col-6">
        <a href="/explore" class="btn btn-primary btn-sm" id="search" style="border-radius: 5px;">
            <i data-feather="search" class="center-button-icon"></i>
            Explore more datasets
        </a>
    </div>

</div>

<div class="row">

    <div class="col-xl-8 col-lg-12 col-md-12 col-sm-12">

        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <h1><b>{{ dataset.ds_meta_data.title }}</b></h1>
                    <div>
                        <span class="badge bg-secondary">{{ dataset.get_cleaned_data_category() }}</span>
                    </div>
                </div>
                <p class="text-secondary">{{ dataset.created_at.strftime('%B %d, %Y at %I:%M %p') }}</p>

                <div class="row mb-4">

                    <div class="col-md-4 col-12">
                        <span class=" text-secondary">
                            Description
                        </span>
                    </div>
                    <div class="col-md-8 col-12">
                        <p class="card-text">{{ dataset.ds_meta_data.description }}</p>
                    </div>

                </div>

                <div class="row mb-2">

                    <div class="col-md-4 col-12">
                        <span class=" text-secondary">
                            Uploaded by
                        </span>
                    </div>
                    <div class="col-md-8 col-12">
                        <a href="#">{{ dataset.user.profile.surname }}, {{ dataset.user.profile.name }}</a>
                    </div>

                </div>

                <div class="row mb-2">

                    <div class="col-md-4 col-12">
                        <span class=" text-secondary">
                            Authors
                        </span>
                    </div>
                    <div class="col-md-8 col-12">
                        {% for author in dataset.ds_meta_data.authors %}
                        <p class="p-0 m-0">
                            {{ author.name }}
                            {% if author.affiliation %}
                            ({{ author.affiliation }})
                            {% endif %}
                            {% if author.orcid %}
                            ({{ author.orcid }})
                            {% endif %}
                        </p>
                        {% endfor %}
                    </div>


                </div>

                {% if dataset.ds_meta_data.publication_doi %}
                <div class="row mb-2">
                    <div class="col-md-4 col-12">
                        <span class="text-secondary">
                            Publication DOI
                        </span>
                    </div>
                    <div class="col-md-8 col-12">
                        <a href="{{ dataset.ds_meta_data.publication_doi }}">
                            {{ dataset.ds_meta_data.publication_doi }}
                        </a>
                    </div>
                </div>
                {% endif %}

                {% if dataset.ds_meta_data.dataset_doi %}
                <div class="row mb-2">
                    
                        <div class="col-md-4 col-12">
                            <span class=" text-secondary">
                                Fakenodo record
                            </span>
                        </div>

                        <div class="col-md-8 col-12">
                            <a href="https://{{ fakenodo_url }}/records/{{ dataset.ds_meta_data.deposition_id }}" target="_blank">
                                https://{{ fakenodo_url }}/records/{{ dataset.ds_meta_data.deposition_id }}
                            </a>
                        </div>

                </div>
                {% endif %}
                <div class="row mb-2">

                    <div class="col-md-4 col-12">
                        <span class=" text-secondary">
                            Tags
                        </span>
                    </div>
                    <div class="col-md-8 col-12">
                        {% set tag_list = dataset.ds_meta_data.tags.split(',') if dataset.ds_meta_data.tags else [] %}
                        {% for tag in tag_list %}
                        <span class="badge bg-secondary">{{ tag.strip() }}</span>
                        {% endfor %}
                    </div>

                </div>

                

            </div>

        </div>


        {% if related_datasets %}
        <div class="related-section-container">
            <div class="related-section-header">
                <h3 class="related-section-title">Related Datasets</h3>
                <span class="related-section-count">{{ related_datasets|length }} suggestions</span>
            </div>

            <div class="related-section-body">
                <div class="related-section-grid">
                    {% for item in related_datasets %}
                    <div class="related-dataset-card">
                        <div class="related-card-content">

                            <div class="related-card-main">
                                <a class="related-title" href="{{ url_for('dataset.subdomain_index', doi=item.dataset.ds_meta_data.dataset_doi) }}">
                                    {{ item.dataset.ds_meta_data.title }}
                                </a>

                                <div class="related-meta">
                                    {% set first_author = item.dataset.ds_meta_data.authors | first %}
                                    {% if first_author %}
                                        {{ first_author.name }}
                                    {% endif %}
                                    · {{ item.dataset.ds_meta_data.data_category.name.replace('_', ' ').title() }}
                                </div>

                                <div class="related-badges">
                                    {% if item.accepted_community %}
                                    <span class="badge related-badge">{{ item.accepted_community.name }}</span>
                                    {% endif %}

                                    {% set related_tags = item.dataset.ds_meta_data.tags.split(',') if item.dataset.ds_meta_data.tags else [] %}
                                    {% for tag in related_tags[:3] %}
                                    <span class="badge related-badge">{{ tag.strip() }}</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="related-stats">
                                <div><i data-feather="download" class="me-1"></i>{{ item.download_count or 0 }} downloads</div>
                                <div><i data-feather="calendar" class="me-1"></i>{{ item.dataset.created_at.strftime('%b %d, %Y') }}</div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}


    </div>

    <div class="col-xl-4 col-lg-12 col-md-12 col-sm-12">

        <div class="list-group">
            {% include 'dataset/_files_block.html' ignore missing %}
        </div>

        {% if accepted_community %}
        <div class="card mt-3">
            <div class="card-body d-flex align-items-center">
                {% if accepted_community.icon_path %}
                <img src="{{ url_for('community.community_icon', community_id=accepted_community.id) }}" alt="icon" style="width:32px;height:32px;object-fit:cover;border-radius:4px;margin-right:8px;" />
                {% endif %}
                <div>
                    <div class="text-muted" style="font-size: 0.9rem;">Community</div>
                    <a class="fw-bold" href="{{ url_for('community.view_community', community_id=accepted_community.id) }}">{{ accepted_community.name }}</a>
                </div>
            </div>
        </div>
        {% endif %}

        {% if current_user.is_authenticated and current_user.id == dataset.user_id and can_propose %}
        <div class="card mt-3">
            <div class="card-body">
                <h6 class="card-title">Propose to a community</h6>
                {% if communities and communities|length > 0 %}
                <form method="post" action="{{ url_for('community.propose_dataset_to_community') }}">
                    <input type="hidden" name="dataset_id" value="{{ dataset.id }}" />
                    <div class="input-group">
                        <select name="community_id" class="form-select" required>
                            {% for c in communities %}
                            <option value="{{ c.id }}">{{ c.name }}</option>
                            {% endfor %}
                        </select>
                        <button class="btn btn-outline-primary" type="submit">Propose</button>
                    </div>
                </form>
                {% else %}
                <p class="text-muted">No communities available yet.</p>
                <a class="btn btn-sm btn-primary" href="{{ url_for('community.create_community') }}">Create one</a>
                {% endif %}
            </div>
        </div>
        {% endif %}


        <a href="{{ url_for('dataset.download_dataset', dataset_id=dataset.id) }}" class="btn btn-primary mt-3" style="border-radius: 5px;">
            <i data-feather="download" class="center-button-icon"></i>
            Download all ({{ dataset.get_file_total_size_for_human() }})
        </a>
    </div>
    
</div>

<!-- Modal-->
<div class="modal fade" id="fileViewerModal" tabindex="-1" aria-labelledby="fileViewerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" style="height: 80vh; display: flex; align-items: center;">
        <div class="modal-content" style="height: 80vh;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h5 class="modal-title" id="fileViewerModalLabel">Feature model view</h5>
                <div>
                    <a href="#" class="btn btn-outline-primary btn-sm" id="downloadButton"
                        style="margin-right: 5px; margin-bottom: 5px; border-radius: 5px;">
                        <i data-feather="download"></i>
                    </a>
                    <button onclick="copyToClipboard()" class="btn btn-outline-secondary btn-sm"
                        style="margin-right: 5px; margin-bottom: 5px; border-radius: 5px;">
                        <i data-feather="copy"></i>
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
            </div>
            <div class="modal-body" style="overflow-y: auto; height: calc(100vh - 50px);">
                <pre id="fileContent" style="height: 100%; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word; background-color: #f5f5f5; padding: 20px; border-radius: 5px; border: 1px solid #ccc;"></pre>
                <div id="csvPreview" style="display:none;">
                    <div class="table-responsive">
                        <table class="table table-sm table-striped" id="csvPreviewTable">
                            <thead></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- Hidden element to carry Flask's SCRIPT_ROOT for subpath deployments -->
<span id="script-root" data-root="{{ request.script_root|default('') }}" style="display:none"></span>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        feather.replace();
        applyRelatedSectionStyles();
    });

    var currentFileId;
    // Injected via data attribute to avoid breaking static JS parsing
    const ROOT = (document.getElementById('script-root')?.dataset.root) || '';

    function viewFile(fileId) {
        fetch(`${ROOT}/file/view/${fileId}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('fileContent').textContent = data.content;
                document.getElementById('fileContent').style.display = 'block';
                document.getElementById('csvPreview').style.display = 'none';
                currentFileId = fileId;
                document.getElementById('downloadButton').href = `${ROOT}/file/download/${fileId}`;
                var modal = new bootstrap.Modal(document.getElementById('fileViewerModal'));
                modal.show();
            })
            .catch(error => console.error('Error loading file:', error));
    }

    function previewCSV(fileId) {
        fetch(`${ROOT}/dataset/file/preview/${fileId}`)
            .then(response => response.json())
            .then(data => {
                const preview = document.getElementById('csvPreview');
                const pre = document.getElementById('fileContent');
                const thead = document.querySelector('#csvPreviewTable thead');
                const tbody = document.querySelector('#csvPreviewTable tbody');

                // Clear
                thead.innerHTML = '';
                tbody.innerHTML = '';

                // Headers
                const trHead = document.createElement('tr');
                (data.headers || []).forEach(h => {
                    const th = document.createElement('th');
                    th.textContent = h;
                    trHead.appendChild(th);
                });
                thead.appendChild(trHead);

                // Rows
                (data.rows || []).forEach(r => {
                    const tr = document.createElement('tr');
                    r.forEach(c => {
                        const td = document.createElement('td');
                        td.textContent = c;
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });

                pre.style.display = 'none';
                preview.style.display = 'block';
                currentFileId = fileId;
                document.getElementById('downloadButton').href = `${ROOT}/file/download/${fileId}`;
                var modal = new bootstrap.Modal(document.getElementById('fileViewerModal'));
                modal.show();
            })
            .catch(error => console.error('Error loading preview:', error));
    }

    function showLoading() {
        document.getElementById("loading").style.display = "initial";
    }

    function hideLoading() {
        document.getElementById("loading").style.display = "none";
    }
    function copyToClipboard() {
        const text = document.getElementById('fileContent').textContent;
        navigator.clipboard.writeText(text).then(() => {
            console.log('Text copied to clipboard');
        }).catch(err => {
            console.error('Failed to copy text: ', err);
        });
    }

    function applyRelatedSectionStyles() {
        const containers = document.querySelectorAll('.related-section-container, .related-section-body');
        if (!containers.length) {
            return;
        }

        const containerStyles = {
            background: '#fbfdff',
            border: '1px solid rgba(15,23,42,0.06)',
            borderRadius: '14px',
            boxShadow: '0 10px 25px rgba(2,6,23,0.04)',
            padding: '18px'
        };

        const cardStyles = {
            background: 'linear-gradient(180deg,#ffffff 0%,#fbfdff 100%)',
            border: '1px solid rgba(15,23,42,0.04)',
            borderRadius: '12px',
            boxShadow: '0 10px 22px rgba(2,6,23,0.03)',
            padding: '12px',
            transition: 'transform .12s ease, box-shadow .16s ease'
        };

        const titleStyles = {
            color: '#0f172a',
            fontWeight: '700',
            textDecoration: 'none'
        };

        const metaStyles = {
            color: '#6b7280'
        };

        const badgeStyles = {
            background: '#f1f5f9',
            color: '#0f172a',
            border: '1px solid rgba(15,23,42,0.03)',
            borderRadius: '999px',
            fontSize: '0.72rem',
            padding: '0.18rem 0.5rem'
        };

        const statsStyles = {
            color: '#475569',
            textAlign: 'right',
            minWidth: '120px'
        };

        containers.forEach(el => Object.assign(el.style, containerStyles));

        document.querySelectorAll('.related-dataset-card').forEach(card => {
            card.classList.remove('card', 'shadow-sm');
            Object.assign(card.style, cardStyles);
        });

        document.querySelectorAll('.related-title').forEach(title => {
            Object.assign(title.style, titleStyles);
        });

        document.querySelectorAll('.related-meta').forEach(meta => {
            Object.assign(meta.style, metaStyles);
        });

        document.querySelectorAll('.related-badge').forEach(badge => {
            Object.assign(badge.style, badgeStyles);
        });

        document.querySelectorAll('.related-stats').forEach(stats => {
            Object.assign(stats.style, statsStyles);
        });
    }
</script>

{% endblock %}
