{% extends "base_template.html" %}

{% block title %}Report issue{% endblock %}

{% block content %}

  <div class="container mt-4">
    <h1 class="h2 mb-3"><b>Notify</b> issue with dataset</h1>

    <div class="card">
      <div class="card-body">
        <form id="report-form">
          <div class="mb-3">
            <label for="description" class="form-label">Why should this dataset be notified for?</label>
            <textarea id="description" name="description" class="form-control" rows="6" required></textarea>
          </div>

          <div class="d-flex justify-content-between">
            <a href="{{ dataset.get_steamgameshub_doi() }}" class="btn btn-outline-secondary">Cancel</a>
            <button id="send-issue" type="submit" class="btn btn-primary">Send issue</button>
          </div>
        </form>

        <div id="report-feedback" class="mt-3" style="display:none"></div>
      </div>
    </div>
  </div>

{% endblock %}

{% block scripts %}
  <script>
    document.getElementById('report-form').addEventListener('submit', async function (e) {
      e.preventDefault();
      const desc = document.getElementById('description').value.trim();
      const feedback = document.getElementById('report-feedback');
      feedback.style.display = 'none';
      feedback.className = '';

      if (!desc) {
        feedback.style.display = '';
        feedback.className = 'alert alert-danger';
        feedback.textContent = 'Description is required';
        return;
      }

      try {
        const resp = await fetch("{{ url_for('dataset.create_issue') }}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ dataset_id: {{ dataset.id }}, description: desc })
        });

        if (resp.status === 201) {
          feedback.style.display = '';
          feedback.className = 'alert alert-success';
          feedback.textContent = 'Issue reported successfully.';
          // Optionally redirect after a short delay
          setTimeout(() => { window.location.href = '{{ dataset.get_steamgameshub_doi() }}'; }, 800);
        } else if (resp.status === 403) {
          feedback.style.display = '';
          feedback.className = 'alert alert-danger';
          feedback.textContent = 'You do not have permission to report issues.';
        } else {
          const body = await resp.json().catch(() => ({}));
          feedback.style.display = '';
          feedback.className = 'alert alert-danger';
          feedback.textContent = body.message || ('Error reporting issue: ' + resp.status);
        }
      } catch (err) {
        feedback.style.display = '';
        feedback.className = 'alert alert-danger';
        feedback.textContent = 'Error reporting issue: ' + err;
      }
    });
  </script>
{% endblock %}
