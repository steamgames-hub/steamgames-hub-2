{% extends "base_template.html" %}

{% block title %}Users List{% endblock %}

{% block content %}
<div class="container-fluid p-0">
	<h1 class="h3 mb-3"><b>Role</b> management</h1>
	<div class="row">
		<div class="col-12">
			<div class="card">
				<div class="card-body">
					<table class="table">
						<thead>
							<tr>
								<th>Name</th>
								<th>Surname</th>
								<th>Affiliation</th>
								<th>Email</th>
								<th>Role</th>
								<th>Options</th>
							</tr>
						</thead>
						<tbody>
						{% for user in users %}
							<tr>
								<td>{{ user.profile.name }}</td>
								<td>{{ user.profile.surname }}</td>
								<td>{{ user.profile.affiliation }}</td>
								<td>{{ user.email }}</td>
								<td>{{ user.role.name }}</td>
								<td>
									{% if user.id != current_user.id %}
										{% if user.role.name != 'ADMIN' %}
											<button class="btn btn-success btn-sm user-upgrade" data-user-id="{{ user.id }}">Upgrade</button>
										{% endif %}
										{% if user.role.name != 'USER' %}
											<button class="btn btn-warning btn-sm user-downgrade" data-user-id="{{ user.id }}">Downgrade</button>
										{% endif %}
										<a class="btn btn-primary btn-sm" href="{{ url_for('profile.edit_profile', user_id=user.id) }}">Edit</a>
										<button class="btn btn-danger btn-sm user-delete" data-user-id="{{ user.id }}">Delete</button>
									{% else %}
										<a class="btn btn-primary btn-sm" href="{{ url_for('profile.edit_profile', user_id=user.id) }}">Edit</a>
									{% endif %}
								</td>
							</tr>
						{% endfor %}
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
</div>
<script>
	document.querySelectorAll('.user-upgrade').forEach(button => {
		button.addEventListener('click', function () {
			fetch(`/user/upgrade/${button.dataset.userId}`, {
				method: 'POST',
				headers: { 'X-Requested-With': 'XMLHttpRequest' }
			})
			.then(response => {
				if (response.ok) {
					window.location.reload();
				} else {
					response.json().then(data => alert(data.message || 'Error'));
				}
			});
		});
	});
	document.querySelectorAll('.user-downgrade').forEach(button => {
		button.addEventListener('click', function () {
			fetch(`/user/downgrade/${button.dataset.userId}`, {
				method: 'POST',
				headers: { 'X-Requested-With': 'XMLHttpRequest' }
			})
			.then(response => {
				if (response.ok) {
					window.location.reload();
				} else {
					response.json().then(data => alert(data.message || 'Error'));
				}
			});
		});
	});
	document.querySelectorAll('.user-delete').forEach(button => {
		button.addEventListener('click', function () {
			if (!confirm('Are you sure you want to delete this user?')) return;
			fetch(`/user/delete/${button.dataset.userId}`, {
				method: 'DELETE',
				headers: { 'X-Requested-With': 'XMLHttpRequest' }
			})
			.then(response => {
				if (response.ok) {
					window.location.reload();
				} else {
					response.json().then(data => alert(data.message || 'Error'));
				}
			});
		});
	});
</script>
{% endblock %}
